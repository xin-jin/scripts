#!/usr/bin/env ocaml

#use "topfind";;
#require "batteries";;
#require "core";;

open Core
open Batteries

(* let read_filename = *)
(*   Command.Spec.Arg_type.create *)
(*     (fun filename -> *)
(*        match Sys.is_file filename with *)
(*        | `Yes -> filename *)
(*        | `No | `Unknown -> *)
(*          eprintf "'%s' is not a regular file." filename; *)
(*          exit 1 *)
(*     ) *)

let do_compile file () =
  let file_noetn = file |> Str.replace_first (Str.regexp "\\.ml$") "" in
  Unix.system @@ "ocamlfind ocamlopt -linkpkg -thread -package core,batteries -o "+file_noetn+".native "+file

let command =
  Command.basic
    ~summary:"Compile with customized flags."
    ~readme:(fun () -> "Nothing fancy.")
    Command.Spec.(empty +> anon ("filename" %: string))
    do_compile

let () = Command.run ~version:"0.1" command
